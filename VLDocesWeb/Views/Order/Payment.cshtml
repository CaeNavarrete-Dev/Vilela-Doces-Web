@model VLDocesWeb.Models.PaymentSummaryViewModel
@{
    Layout = "_FluxoPedido";
    ViewData["Title"] = "Pagamento";
    ViewData["Layout-Title"] = "Forma de Pagamento";
    
    // Recupera a flag vinda do Controller
    bool ehEncomenda = ViewBag.TemEncomenda ?? false;
}

<a href="~/Address/Index" class="btn btn-outline-secondary btn-lg mb-2"><i class="bi bi-arrow-left"></i></a>

<form action="/Order/ProcessPayment/" method="POST" id="paymentForm">
  <div class="row">      
    <div class="col-md-8">
      <div class="card p-4 shadow-sm bg-light-subtle">
        <input type="hidden" name="TotalGeral" value="@Model.TotalGeral" />

        @if (ehEncomenda)
        {
            <div class="alert alert-info">
                <i class="fas fa-calendar-alt"></i> <strong>Pedido sob Encomenda</strong><br>
                Selecione a data de entrega e a forma de pagamento do sinal.
            </div>

            <div class="mb-4 border-bottom pb-3">
                <label class="form-label fw-bold">Data da Entrega:</label>
                <input type="date" class="form-control w-50" name="DataEntregaAgendada" required min="@DateTime.Now.AddDays(2).ToString("yyyy-MM-dd")">
            </div>

            <h5 class="mb-3">Como deseja pagar?</h5>

            <div class="form-check p-3 mb-2 border rounded bg-white">
                <input class="form-check-input" type="radio" name="OpcaoPagamentoEncomenda" id="opt1" value="1" onchange="handleEncomendaChange()" checked>
                <label class="form-check-label ms-2" for="opt1">
                    <strong>Pagar valor total agora (PIX)</strong>
                    <p class="mb-0 text-muted small">Valor total: @Model.TotalGeral.ToString("C2")</p>
                </label>
            </div>

            <div class="form-check p-3 mb-2 border rounded bg-white">
                <input class="form-check-input" type="radio" name="OpcaoPagamentoEncomenda" id="opt2" value="2" onchange="handleEncomendaChange()">
                <label class="form-check-label ms-2" for="opt2">
                    <strong>Sinal (50% Pix) + Restante (50% Pix na Entrega)</strong>
                    <p class="mb-0 text-muted small">Pague @((Model.TotalGeral/2).ToString("C2")) agora e o restante no dia.</p>
                </label>
            </div>

            <div class="form-check p-3 mb-2 border rounded bg-white">
                <input class="form-check-input" type="radio" name="OpcaoPagamentoEncomenda" id="opt3" value="3" onchange="handleEncomendaChange()">
                <label class="form-check-label ms-2" for="opt3">
                    <strong>Sinal (50% Pix) + Restante (50% Dinheiro na Entrega)</strong>
                    <p class="mb-0 text-muted small">Necessário sinal via Pix agora.</p>
                </label>
            </div>
        }
        else
        {
            <div class="form-check p-3 mb-3 border-bottom payment-option">
              <input class="form-check-input" type="radio" name="formaPagamento" id="opcaoDinheiro" value="0" checked onchange="handlePaymentChange()">
              <label class="form-check-label ms-2 d-block" for="opcaoDinheiro">
                  <strong class="text-dark">Dinheiro (Pagamento na Entrega)</strong>
              </label>
            </div>

            <div class="form-check p-3 mb-3 border-bottom payment-option">
              <input class="form-check-input" type="radio" name="formaPagamento" id="opcaoPix" value="1" onchange="handlePaymentChange()">
              <label class="form-check-label ms-2 d-block" for="opcaoPix">
                  <strong class="text-dark">PIX</strong>
              </label>
            </div>
        }

        <div id="troco-details" class="p-3 mt-4 bg-white border rounded shadow-sm d-none">
          <h5 class="text-success mb-3">Informações de Troco</h5>
          
          @if(ehEncomenda) {
              <p class="text-muted small mb-3">O valor a pagar na entrega será: <span class="fw-bold">@((Model.TotalGeral/2).ToString("C2"))</span></p>
          } else {
              <p class="text-muted small mb-3">O total do seu pedido é: <span class="fw-bold">@Model.TotalGeral.ToString("C2")</span></p>
          }

          <div class="form-check mb-3">
             <input class="form-check-input" type="checkbox" name="NaoPrecisoTroco" value="true" id="naoPrecisoTroco">
            <label class="form-check-label mt-1" for="naoPrecisoTroco">Não preciso de troco.</label>
          </div>

          <div class="input-group">
            <span class="input-group-text bg-light"> Preciso de troco para:</span>
            <input type="number" class="form-control" name="ValorTroco" id="valor-troco-input" step="any">
          </div>
        </div>

        <div id="pix-details" class="p-3 mt-4 bg-white border rounded shadow-sm @(ehEncomenda ? "" : "d-none")"> 
          <h5 class="text-center text-success mb-3">Pagamento PIX</h5>
          <div class="text-center mb-4">
            <img src="https://pngimg.com/uploads/qr_code/qr_code_PNG33.png" class="img-fluid border p-1" style="max-width: 180px;">
          </div>
          <div class="input-group mb-3">
            <input type="text" class="form-control" value="vileladoces@email.com" id="pix-key-input" readonly>
            <button class="btn btn-outline-secondary" type="button" id="copy-pix-key">Copiar</button>
          </div>
          
          <p class="text-danger small text-center" id="msg-valor-pix">
              @if(ehEncomenda) {
                 <span>Valor a pagar agora: <strong>@Model.TotalGeral.ToString("C2")</strong></span>
              } else {
                 <span>Valor total: <strong>@Model.TotalGeral.ToString("C2")</strong></span>
              }
          </p>
        </div>

      </div>
    </div>

    <div class="col-md-4">
      <div class="card p-4 shadow-lg sticky-top resumo-card">
        <h4 class="card-title">Resumo</h4>
        <hr>
        <div class="d-flex justify-content-between text-muted small">
          <span>Subtotal:</span>
          <span>@Model.Subtotal.ToString("C2")</span>
        </div>
        <div class="d-flex justify-content-between text-muted small mb-2">
          <span>Frete:</span>
          <span>@Model.Frete.ToString("C2")</span>
        </div>
        <div class="d-flex justify-content-between mt-2 total-line">
          <span class="fs-4">Total:</span>
          <span class="fs-4 fw-bold text-success">@Model.TotalGeral.ToString("C2")</span>
        </div>
        <hr class="mt-3">
        <div class="mb-3">
            <label class="form-label fw-bold">Observações:</label>
            <textarea class="form-control" name="Observacoes" rows="3"></textarea>
        </div>
        <button type="submit" class="btn btn-lg btn-success mt-2 w-100">Confirmar Pedido</button>
      </div>
    </div>
  </div>
</form>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const ehEncomenda = @(ehEncomenda.ToString().ToLower()); // Passa valor C# para JS
    const pixDetails = document.getElementById('pix-details');
    const trocoDetails = document.getElementById('troco-details');
    const msgValorPix = document.getElementById('msg-valor-pix');
    
    // Valores para texto
    const valorTotal = "@Model.TotalGeral.ToString("C2")";
    const valorMetade = "@((Model.TotalGeral/2).ToString("C2"))";

    window.handleEncomendaChange = function() {
        const optSelected = document.querySelector('input[name="OpcaoPagamentoEncomenda"]:checked').value;
        
        // Sempre mostra PIX na encomenda (pois sempre tem sinal ou pagamento total)
        pixDetails.classList.remove('d-none');

        // Atualiza mensagem do valor do PIX
        if(optSelected === "1") {
            msgValorPix.innerHTML = "Valor a pagar agora: <strong>" + valorTotal + "</strong>";
        } else {
            msgValorPix.innerHTML = "Valor do SINAL a pagar agora: <strong>" + valorMetade + "</strong>";
        }

        // Mostra Troco APENAS se for opção 3 (metade dinheiro)
        if(optSelected === "3") {
            trocoDetails.classList.remove('d-none');
        } else {
            trocoDetails.classList.add('d-none');
        }
    }

    window.handlePaymentChange = function() {
        const dinheiroRadio = document.getElementById('opcaoDinheiro');
        if (dinheiroRadio && dinheiroRadio.checked) {
            trocoDetails.classList.remove('d-none');
            pixDetails.classList.add('d-none');
        } else {
            trocoDetails.classList.add('d-none');
            pixDetails.classList.remove('d-none');
        }
    };

    // Inicialização
    if(ehEncomenda) {
        handleEncomendaChange();
    } else {
        handlePaymentChange();
    }

    // (Lógica existente do Checkbox de troco e copiar Pix mantém-se igual...)
    const checkboxTroco = document.getElementById('naoPrecisoTroco');
    const inputTroco = document.getElementById('valor-troco-input');
    if(checkboxTroco){
        checkboxTroco.addEventListener('change', function(){
            inputTroco.disabled = this.checked;
            if(this.checked) inputTroco.value = '';
        });
    }
  });
</script>